package com.gestionfacture;

import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

public class UserPanel extends JPanel {
    private JTable dgvUsers;
    private JLabel lblNote;

    public UserPanel() {
        initializeComponents();
        loadUsers();
    }

    private void initializeComponents() {
        setBounds(0, 0, 1356, 688);
        setBackground(Color.WHITE);
        setLayout(null);

        // Users Table
        String[] columnNames = {"Login", "Password", "Type Utilisateur"};
        DefaultTableModel model = new DefaultTableModel(columnNames, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                // Allow editing "Login" column only for new rows (empty login)
                if (column == 0) {
                    String login = getValueAt(row, 0) != null ? getValueAt(row, 0).toString() : "";
                    return login.isEmpty(); // Editable if login is empty (new row)
                }
                return true; // Allow editing for other columns
            }
        };
        dgvUsers = new JTable(model);
        dgvUsers.setFillsViewportHeight(true);
        dgvUsers.setRowHeight(25);

        // Set JComboBox editor for "Type Utilisateur" column (index 2)
        JComboBox<String> roleComboBox = new JComboBox<>(new String[]{"Admin", "User"});
        dgvUsers.getColumnModel().getColumn(2).setCellEditor(new DefaultCellEditor(roleComboBox));

        // Center-align text in the table
        DefaultTableCellRenderer centerRenderer = new DefaultTableCellRenderer();
        centerRenderer.setHorizontalAlignment(JLabel.CENTER);
        for (int i = 0; i < dgvUsers.getColumnCount(); i++) {
            dgvUsers.getColumnModel().getColumn(i).setCellRenderer(centerRenderer);
        }

        JScrollPane scrollPane = new JScrollPane(dgvUsers);
        scrollPane.setBounds(12, 15, 1199, 297);
        add(scrollPane);

        // Note Label
        lblNote = new JLabel("* Right-click to add/delete a user. Click a cell to edit (Login for new users only).");
        lblNote.setBounds(594, 479, 450, 20);
        lblNote.setForeground(Color.RED);
        add(lblNote);

        // Table cell editor listener to save changes to the database
        dgvUsers.getModel().addTableModelListener(e -> {
            int row = e.getFirstRow();
            int column = e.getColumn();
            if (row >= 0 && column >= 0) {
                DefaultTableModel modelData = (DefaultTableModel) dgvUsers.getModel();
                String login = modelData.getValueAt(row, 0) != null ? modelData.getValueAt(row, 0).toString() : "";
                String password = modelData.getValueAt(row, 1) != null ? modelData.getValueAt(row, 1).toString() : "";
                String userType = modelData.getValueAt(row, 2) != null ? modelData.getValueAt(row, 2).toString() : "Admin";

                // Check if this is a new user (was empty before) or an update to an existing user
                boolean isNewUser = false;
                try (Connection conn = DatabaseConnection.getConnection();
                     PreparedStatement pstmt = conn.prepareStatement("SELECT COUNT(*) FROM Utilisateur WHERE Login = ?")) {
                    pstmt.setString(1, login);
                    ResultSet rs = pstmt.executeQuery();
                    if (rs.next() && rs.getInt(1) == 0) {
                        isNewUser = true; // Login doesn't exist in the database, so it's a new user
                    }
                } catch (SQLException ex) {
                    JOptionPane.showMessageDialog(this, "Erreur lors de la vérification de l'utilisateur : " + ex.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
                }

                if (isNewUser && !login.isEmpty()) {
                    // Insert new user
                    try (Connection conn = DatabaseConnection.getConnection();
                         PreparedStatement pstmt = conn.prepareStatement("INSERT INTO Utilisateur (Login, Password, Type_Utilisateur) VALUES (?, ?, ?)")) {
                        pstmt.setString(1, login);
                        pstmt.setString(2, password);
                        pstmt.setString(3, userType);
                        pstmt.executeUpdate();
                        loadUsers();
                    } catch (SQLException ex) {
                        JOptionPane.showMessageDialog(this, "Erreur lors de l'ajout de l'utilisateur : " + ex.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
                    }
                } else if (!isNewUser) {
                    // Update existing user
                    updateUserInDatabase(login, password, userType);
                }
            }
        });

        // Right-click context menu for adding and deleting users
        JPopupMenu popupMenu = new JPopupMenu();
        JMenuItem addMenuItem = new JMenuItem("Add New User");
        JMenuItem deleteMenuItem = new JMenuItem("Delete Selected User");

        addMenuItem.addActionListener(e -> addNewUser());
        deleteMenuItem.addActionListener(e -> showDeleteUserDialog());

        dgvUsers.addMouseListener(new MouseAdapter() {
            @Override
            public void mousePressed(MouseEvent e) {
                if (SwingUtilities.isRightMouseButton(e)) {
                    int row = dgvUsers.rowAtPoint(e.getPoint());
                    if (row >= 0) {
                        dgvUsers.setRowSelectionInterval(row, row);
                    }
                    popupMenu.show(dgvUsers, e.getX(), e.getY());
                }
            }
        });
    }

    private void loadUsers() {
        DefaultTableModel model = (DefaultTableModel) dgvUsers.getModel();
        model.setRowCount(0);

        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM Utilisateur");
             ResultSet rs = pstmt.executeQuery()) {
            while (rs.next()) {
                model.addRow(new Object[]{
                    rs.getString("Login"),
                    rs.getString("Password"),
                    rs.getString("Type_Utilisateur")
                });
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erreur lors du chargement des utilisateurs : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void addNewUser() {
        DefaultTableModel model = (DefaultTableModel) dgvUsers.getModel();
        model.addRow(new Object[]{"", "", "Admin"}); // Add a new row with default values
        int newRow = model.getRowCount() - 1;
        dgvUsers.setRowSelectionInterval(newRow, newRow);
        dgvUsers.editCellAt(newRow, 0); // Start editing the "Login" column of the new row
    }

    private void showDeleteUserDialog() {
        int selectedRow = dgvUsers.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Veuillez sélectionner un utilisateur à supprimer !", "Erreur", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String username = dgvUsers.getValueAt(selectedRow, 0).toString();
        if (username.isEmpty()) {
            ((DefaultTableModel) dgvUsers.getModel()).removeRow(selectedRow);
            return;
        }

        int confirm = JOptionPane.showConfirmDialog(this, "Voulez-vous vraiment supprimer l'utilisateur " + username + " ?", "Confirmer la suppression", JOptionPane.YES_NO_OPTION);
        if (confirm == JOptionPane.YES_OPTION) {
            try (Connection conn = DatabaseConnection.getConnection();
                 PreparedStatement pstmt = conn.prepareStatement("DELETE FROM Utilisateur WHERE Login = ?")) {
                pstmt.setString(1, username);
                int rows = pstmt.executeUpdate();
                if (rows > 0) {
                    loadUsers();
                } else {
                    JOptionPane.showMessageDialog(this, "Utilisateur introuvable !", "Erreur", JOptionPane.ERROR_MESSAGE);
                }
            } catch (SQLException e) {
                JOptionPane.showMessageDialog(this, "Erreur lors de la suppression : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
            }
        }
    }

    private void updateUserInDatabase(String originalLogin, String password, String userType) {
        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("UPDATE Utilisateur SET Password = ?, Type_Utilisateur = ? WHERE Login = ?")) {
            pstmt.setString(1, password);
            pstmt.setString(2, userType);
            pstmt.setString(3, originalLogin);
            int rows = pstmt.executeUpdate();
            if (rows == 0) {
                JOptionPane.showMessageDialog(this, "Utilisateur introuvable !", "Erreur", JOptionPane.ERROR_MESSAGE);
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erreur lors de la mise à jour : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
        }
    }
}