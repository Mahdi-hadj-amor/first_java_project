package com.gestionfacture;

import javax.swing.*;
import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableCellEditor;
import java.awt.*;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

public class UserPanel extends JPanel {
    private JTable dgvUsers;
    private JLabel lblNote;

    public UserPanel() {
        initializeComponents();
        loadUsers();
    }

    private void initializeComponents() {
        setBounds(0, 0, 1356, 688);
        setBackground(Color.WHITE);
        setLayout(null);

        // Users Table
        String[] columnNames = {"Login", "Password", "Type Utilisateur"};
        DefaultTableModel model = new DefaultTableModel(columnNames, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column != 0; // Disable editing for "Login" column (index 0)
            }
        };
        dgvUsers = new JTable(model);
        dgvUsers.setFillsViewportHeight(true);
        dgvUsers.setRowHeight(25);

        // Set JComboBox editor for "Type Utilisateur" column (index 2)
        JComboBox<String> roleComboBox = new JComboBox<>(new String[]{"Admin", "User"});
        dgvUsers.getColumnModel().getColumn(2).setCellEditor(new DefaultCellEditor(roleComboBox));

        // Center-align text in the table
        DefaultTableCellRenderer centerRenderer = new DefaultTableCellRenderer();
        centerRenderer.setHorizontalAlignment(JLabel.CENTER);
        for (int i = 0; i < dgvUsers.getColumnCount(); i++) {
            dgvUsers.getColumnModel().getColumn(i).setCellRenderer(centerRenderer);
        }

        JScrollPane scrollPane = new JScrollPane(dgvUsers);
        scrollPane.setBounds(12, 15, 1199, 297);
        add(scrollPane);

        // Note Label
        lblNote = new JLabel("* Right-click on the table to add or delete a user. Click a cell to edit.");
        lblNote.setBounds(594, 479, 400, 20);
        lblNote.setForeground(Color.RED);
        add(lblNote);

        // Table cell editor listener to save changes to the database
        dgvUsers.getModel().addTableModelListener(e -> {
            int row = e.getFirstRow();
            int column = e.getColumn();
            if (row >= 0 && column >= 0) {
                DefaultTableModel modelData = (DefaultTableModel) dgvUsers.getModel();
                String originalLogin = modelData.getValueAt(row, 0).toString();
                String password = modelData.getValueAt(row, 1).toString();
                String userType = modelData.getValueAt(row, 2).toString();
                updateUserInDatabase(originalLogin, password, userType);
            }
        });

        // Right-click context menu for adding and deleting users
        JPopupMenu popupMenu = new JPopupMenu();
        JMenuItem addMenuItem = new JMenuItem("Add New User");
        JMenuItem deleteMenuItem = new JMenuItem("Delete Selected User");

        addMenuItem.addActionListener(e -> addNewUser());
        deleteMenuItem.addActionListener(e -> deleteSelectedUser());

        popupMenu.add(addMenuItem);
        popupMenu.add(deleteMenuItem);

        dgvUsers.addMouseListener(new MouseAdapter() {
            @Override
            public void mousePressed(MouseEvent e) {
                if (SwingUtilities.isRightMouseButton(e)) {
                    int row = dgvUsers.rowAtPoint(e.getPoint());
                    if (row >= 0) {
                        dgvUsers.setRowSelectionInterval(row, row);
                    }
                    popupMenu.show(dgvUsers, e.getX(), e.getY());
                }
            }
        });
    }

    private void loadUsers() {
        DefaultTableModel model = (DefaultTableModel) dgvUsers.getModel();
        model.setRowCount(0);

        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("SELECT * FROM Utilisateur");
             ResultSet rs = pstmt.executeQuery()) {
            while (rs.next()) {
                model.addRow(new Object[]{
                    rs.getString("Login"),
                    rs.getString("Password"),
                    rs.getString("Type_Utilisateur")
                });
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erreur lors du chargement des utilisateurs : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void addNewUser() {
        DefaultTableModel model = (DefaultTableModel) dgvUsers.getModel();
        model.addRow(new Object[]{"", "", "Admin"}); // Add a new row with default values
        int newRow = model.getRowCount() - 1;
        dgvUsers.setRowSelectionInterval(newRow, newRow);
        dgvUsers.editCellAt(newRow, 0); // Start editing the "Login" column of the new row
    }

    private void deleteSelectedUser() {
        int selectedRow = dgvUsers.getSelectedRow();
        if (selectedRow < 0) {
            JOptionPane.showMessageDialog(this, "Veuillez sélectionner un utilisateur à supprimer !", "Erreur", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String username = dgvUsers.getValueAt(selectedRow, 0).toString();
        if (username.isEmpty()) {
            ((DefaultTableModel) dgvUsers.getModel()).removeRow(selectedRow);
            return;
        }

        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("DELETE FROM Utilisateur WHERE Login = ?")) {
            pstmt.setString(1, username);
            int rows = pstmt.executeUpdate();
            if (rows > 0) {
                loadUsers();
            } else {
                JOptionPane.showMessageDialog(this, "Utilisateur introuvable !", "Erreur", JOptionPane.ERROR_MESSAGE);
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erreur lors de la suppression : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void updateUserInDatabase(String originalLogin, String password, String userType) {
        try (Connection conn = DatabaseConnection.getConnection();
             PreparedStatement pstmt = conn.prepareStatement("UPDATE Utilisateur SET Password = ?, Type_Utilisateur = ? WHERE Login = ?")) {
            pstmt.setString(1, password);
            pstmt.setString(2, userType);
            pstmt.setString(3, originalLogin);
            int rows = pstmt.executeUpdate();
            if (rows == 0) {
                JOptionPane.showMessageDialog(this, "Utilisateur introuvable !", "Erreur", JOptionPane.ERROR_MESSAGE);
            }
        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erreur lors de la mise à jour : " + e.getMessage(), "Erreur", JOptionPane.ERROR_MESSAGE);
        }
    }
}